@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="container">
    <div class="col-lg-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="目的城市" style="height:100%">
            <span class="input-group-btn">
                <button class="btn btn-default" type="button">Go!</button>
            </span>
        </div>
    </div>
    <div class="buildBtn">
        <button id="buildRoute" class="btn btn-block btn-success" type="button">生成旅游路线</button>
    </div>
</div>
<div id="panel"></div>
<script>
    $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };

    var model = {};
    model.SelectStateArray = [];
    var lnglatXY=[121.498586, 31.239637]	//默认地址：上海市
    var map = new AMap.Map('container',{
        zoom: 10,
        center: lnglatXY
    });
    AMap.service('AMap.Geocoder', function () {//回调函数
        //实例化Geocoder
        geocoder = new AMap.Geocoder({
            city: "010"//城市，默认：“全国”
        });
        //TODO: 使用geocoder 对象完成相关功能
        geocoder.getAddress(lnglatXY, function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                model.CityId = result.regeocode.addressComponent.citycode;
                AMap.service('AMap.PlaceSearch', function () {//回调函数
                    var placeSearch = new AMap.PlaceSearch({ //构造地点查询类
                        pageSize: 50,
                        pageIndex: 1,
                        type: '风景名胜',
                        city: result.regeocode.addressComponent.citycode, //城市
                        map: map,
                        panel: "panel"
                    });
                    //关键字查询
                    placeSearch.search('', function (status, result) {
                        //给panel每条右边加选择框
                        $("ul .poibox").on("click", function () {
                            if ($(this).css("background-Color") == "rgb(246, 246, 246)") {
                                $(this).css("background-Color", "green");
                                model.SelectStateArray.push(result.poiList.pois[$(this).index()].id);
                            }
                            else {
                                $(this).css("background-Color", "");
                            }
                        });
                    });
                });
            } else {
                //获取地址失败
            }
        });
    });
    
    $("#buildRoute").on("click", function () {
        var tempForm = document.createElement("form");
        tempForm.id = "tempForm1";
        tempForm.method = "post";
        tempForm.action = "/home/TestPost";
        tempForm.target = "_blank";
        
        createInput("cityid", model.CityId, tempForm);
        for (var i = 0; i < model.SelectStateArray.length; i++) {
            createInput("SelectStateArray["+i+"]", model.SelectStateArray[i], tempForm);
        }
        document.body.appendChild(tempForm);
        tempForm.submit();
    });

    function createInput(name,value,root) {
        var hidePrintNum = document.createElement("input");
        hidePrintNum.type = "hidden";
        hidePrintNum.name = name;
        hidePrintNum.value = value;
        root.appendChild(hidePrintNum);
    }

</script>
